import React, { useState, useEffect, useCallback } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import { useAuth } from '../../contexts/AuthContext';
import { Link, useNavigate } from 'react-router-dom';
import { toast } from 'react-toastify';
import SlotMachine from './SlotMachine';
import RouletteGame from './RouletteGame';
import BlackjackGame from './BlackJackGame';
import LoginPrompt from '../shared/LoginPrompt';

const CasinoPlay = () => {
  const { isAuthenticated, user, refreshUser } = useAuth();
  const [activeGame, setActiveGame] = useState('slot');
  const [balance, setBalance] = useState({ parc: 0, jpy: 0 });
  const [betAmount, setBetAmount] = useState(10);
  const [isProcessing, setIsProcessing] = useState(false);
  const [demoMode, setDemoMode] = useState(!isAuthenticated); // Êú™„É≠„Ç∞„Ç§„É≥„Å™„Çâ„Éá„É¢„É¢„Éº„Éâ
  const [transaction, setTransaction] = useState(null); // ÂèñÂºïÂ±•Ê≠¥„ÇíË°®Á§∫„Åô„Çã„Åü„ÇÅ„ÅÆÁä∂ÊÖã
  const [previousBalance, setPreviousBalance] = useState(null); // ÂâçÂõû„ÅÆÊÆãÈ´ò„Çí‰øùÂ≠ò
  const [showBalanceChange, setShowBalanceChange] = useState(false); // ÊÆãÈ´òÂ§âÂãïË°®Á§∫„Éï„É©„Ç∞
  const navigate = useNavigate();
  
  // ÊÆãÈ´òÂ§âÊõ¥„Çí„Éè„Ç§„É©„Ç§„ÉàË°®Á§∫„Åô„Çã„Åü„ÇÅ„ÅÆÈñ¢Êï∞
  const highlightBalanceChange = (newBalance, oldBalance) => {
    if (oldBalance !== null && newBalance !== oldBalance) {
      setPreviousBalance(oldBalance);
      setShowBalanceChange(true);
      
      // 3ÁßíÂæå„Å´„Éè„Ç§„É©„Ç§„Éà„ÇíÊ∂à„Åô
      setTimeout(() => {
        setShowBalanceChange(false);
      }, 3000);
    }
  };
  
  // ÊÆãÈ´òÊõ¥Êñ∞„É≠„Ç∏„ÉÉ„ÇØ„ÇíÊîπÂñÑ„Åó„ÄÅ„Ç®„É©„ÉºÊôÇ„Å´„ÇÇÈÅ©Âàá„Å´Âá¶ÁêÜ

const fetchUserBalance = useCallback(async () => {
  if (!isAuthenticated || demoMode) return;

  try {
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 5000); // „Çø„Ç§„É†„Ç¢„Ç¶„Éà„Çí5Áßí„Å´Â¢óÂä†
    
    const response = await fetch('https://example.com/api/users/me', {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${localStorage.getItem('token')}`,
        'Cache-Control': 'no-store, no-cache, must-revalidate, proxy-revalidate',
        'Pragma': 'no-cache'
      },
      cache: 'no-store',
      signal: controller.signal
    });
    
    clearTimeout(timeoutId);
    
    if (response.ok) {
      const userData = await response.json();
      
      // Ââç„ÅÆÊÆãÈ´ò„Å®Êñ∞„Åó„ÅÑÊÆãÈ´ò„ÇíÊØîËºÉ„Åó„Å¶„Éè„Ç§„É©„Ç§„ÉàË°®Á§∫
      if (balance.parc !== userData.balance) {
        highlightBalanceChange(userData.balance, balance.parc);
      }
      
      setBalance({
        parc: userData.balance || 0,
        jpy: userData.jpy_balance || 0
      });
    } else if (response.status === 429) {
      // „É¨„Éº„ÉàÂà∂Èôê„Å´Âºï„Å£„Åã„Åã„Å£„ÅüÂ†¥Âêà„ÅØÈùô„Åã„Å´Â§±Êïó„Åó„ÄÅÊ¨°Âõû„ÅÆ„Éù„Éº„É™„É≥„Ç∞„ÅßÂÜçË©¶Ë°å
      console.log('Rate limit reached for balance update, will retry later');
      // „Ç®„É©„Éº„É°„ÉÉ„Çª„Éº„Ç∏„ÅØË°®Á§∫„Åó„Å™„ÅÑÔºà„É¶„Éº„Ç∂„Éº„Ç®„ÇØ„Çπ„Éö„É™„Ç®„É≥„Çπ„ÇíÁ∂≠ÊåÅÔºâ
    } else {
      console.warn('Failed to fetch user balance:', response.status, response.statusText);
      
      if (response.status === 401 || response.status === 403) {
        await refreshUser();
      } else if (response.status >= 500 && !demoMode) {
        console.warn('Server error occurred. Switching to demo mode.');
        toast.info('„Çµ„Éº„Éê„Éº„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åü„Åü„ÇÅ„ÄÅ„Éá„É¢„É¢„Éº„Éâ„Å´Âàá„ÇäÊõø„Åà„Åæ„Åô„ÄÇ');
        setDemoMode(true);
      }
    }
  } catch (error) {
    if (error.name === 'AbortError') {
      console.log('Balance update request timed out');
    } else {
      console.error('Failed to fetch user balance:', error);
      
      if (!demoMode) {
        console.warn('Connection error. Switching to demo mode.');
        toast.info('Êé•Á∂ö„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åü„Åü„ÇÅ„ÄÅ„Éá„É¢„É¢„Éº„Éâ„Å´Âàá„ÇäÊõø„Åà„Åæ„Åô„ÄÇ');
        setDemoMode(true);
      }
    }
  }
}, [isAuthenticated, balance.parc, refreshUser, demoMode]);
  
  // ÂàùÊúü„É≠„Éº„Éâ„Å®ÂÆöÊúüÁöÑ„Å™ÊÆãÈ´òÊõ¥Êñ∞
  useEffect(() => {
    // ÊúÄÂàù„Å´„É¶„Éº„Ç∂„ÉºÊÉÖÂ†±„Åå„ÅÇ„Çå„Å∞ÊÆãÈ´ò„ÇíË®≠ÂÆö
    if (isAuthenticated && user) {
      setBalance({
        parc: user.balance || 0,
        jpy: user.jpy_balance || 0
      });
      
      // ÂàùÊúüÁä∂ÊÖã„Åß„ÅØÂâçÂõû„ÅÆÊÆãÈ´ò„ÇÇÁèæÂú®„ÅÆÊÆãÈ´ò„Å®Âêå„Åò„Å´Ë®≠ÂÆö
      setPreviousBalance(user.balance || 0);
      
      // ÂàùÂõû„ÅÆ„Éá„Éº„ÇøÂèñÂæó
      fetchUserBalance();
    }
    
    // ÂÆöÊúüÁöÑ„Å´ÊÆãÈ´ò„ÇíÊõ¥Êñ∞ÔºàÈñìÈöî„Çí15Áßí„Åã„Çâ30Áßí„Å´Êã°Â§ßÔºâ
    const intervalId = setInterval(() => {
      if (isAuthenticated && !demoMode) {
        // „É©„É≥„ÉÄ„É†„Å™ÈÅÖÂª∂„ÇíËøΩÂä†„Åó„Å¶„É™„ÇØ„Ç®„Çπ„Éà„ÅÆÈõÜ‰∏≠„ÇíÈÅø„Åë„Çã (jitter)
        const jitter = Math.floor(Math.random() * 5000); // 0-5Áßí„ÅÆ„É©„É≥„ÉÄ„É†„Å™ÈÅÖÂª∂
        setTimeout(() => {
          fetchUserBalance();
        }, jitter);
      }
    }, 30000); // 30Áßí„Åî„Å®„Å´Â§âÊõ¥
    
    return () => clearInterval(intervalId);
  }, [isAuthenticated, user, demoMode, fetchUserBalance]);

  // „Ç´„Çπ„Çø„É†„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÇíË®≠ÂÆö„Åó„Å¶ÊÆãÈ´òÊõ¥Êñ∞„ÇíÊ§úÁü•
  useEffect(() => {
    const handleBalanceUpdate = () => {
      fetchUserBalance();
    };
    
    window.addEventListener('balance-update', handleBalanceUpdate);
    return () => window.removeEventListener('balance-update', handleBalanceUpdate);
  }, [fetchUserBalance]);

  // ÂèñÂºïÊÉÖÂ†±„ÇíË°®Á§∫„Åô„Çã„Åü„ÇÅ„ÅÆ„Çø„Ç§„Éû„Éº
  useEffect(() => {
    if (transaction) {
      const timer = setTimeout(() => {
        setTransaction(null);
      }, 5000); // 5ÁßíÂæå„Å´ÂèñÂºïË°®Á§∫„ÇíÈùûË°®Á§∫„Å´
      
      return () => clearTimeout(timer);
    }
  }, [transaction]);
  
  // „Éá„É¢„É¢„Éº„Éâ„ÅÆÂº∑Âåñ

  // APIÈöúÂÆ≥ÊôÇ„ÅÆÂõûÈÅøÁ≠ñ„Å®„Åó„Å¶„ÄÅÂº∑Âà∂ÁöÑ„Å´„Éá„É¢„É¢„Éº„Éâ„Å´Âàá„ÇäÊõø„Åà„Çã
  useEffect(() => {
    const checkApiHealth = async () => {
      if (!isAuthenticated || demoMode) return;
      
      try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 3000); // 3Áßí„Åß„Çø„Ç§„É†„Ç¢„Ç¶„Éà
        
        const response = await fetch('https://example.com/api/health', {
          signal: controller.signal
        });
        
        clearTimeout(timeoutId);
        
        if (!response.ok) {
          console.warn('API health check failed. Switching to demo mode.');
          toast.info('„Çµ„Éº„Éê„ÉºÈÄö‰ø°„Å´ÂïèÈ°å„Åå„ÅÇ„Çã„Åü„ÇÅ„ÄÅ‰∏ÄÊôÇÁöÑ„Å´„Éá„É¢„É¢„Éº„Éâ„Å´Âàá„ÇäÊõø„Åà„Åæ„Åô„ÄÇ');
          setDemoMode(true);
        }
      } catch (error) {
        console.warn('API health check failed with error:', error);
        toast.info('„Çµ„Éº„Éê„ÉºÈÄö‰ø°„Å´ÂïèÈ°å„Åå„ÅÇ„Çã„Åü„ÇÅ„ÄÅ‰∏ÄÊôÇÁöÑ„Å´„Éá„É¢„É¢„Éº„Éâ„Å´Âàá„ÇäÊõø„Åà„Åæ„Åô„ÄÇ');
        setDemoMode(true);
      }
    };
    
    checkApiHealth();
  }, [isAuthenticated, demoMode]);
  
  // „Éô„ÉÉ„ÉàÈ°ç„Ç™„Éó„Ç∑„Éß„É≥
  const betOptions = [10, 50, 100, 500];
  
  // „Ç≤„Éº„É†„Ç™„Éó„Ç∑„Éß„É≥
  const gameOptions = [
    { id: 'slot', label: '„Çπ„É≠„ÉÉ„Éà„Éû„Ç∑„É≥', icon: 'üé∞' },
    { id: 'roulette', label: '„É´„Éº„É¨„ÉÉ„Éà', icon: 'üé°' },
    { id: 'blackjack', label: '„Éñ„É©„ÉÉ„ÇØ„Ç∏„É£„ÉÉ„ÇØ', icon: 'üÉè' },
  ];
  
  // ÊÆãÈ´ò„Åå‰∏çË∂≥„Åó„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅÆ„ÉÅ„Çß„ÉÉ„ÇØ
  const checkBalance = () => {
    if (demoMode) return true; // „Éá„É¢„É¢„Éº„Éâ„Åß„ÅØÂ∏∏„Å´ÊÆãÈ´ò„ÅÇ„Çä
    if (!isAuthenticated) return false;
    return balance.parc >= betAmount;
  };
  
  // „Ç≤„Éº„É†„Éó„É¨„Ç§ÊôÇ„ÅÆÂá¶ÁêÜÔºà„Éô„ÉÉ„Éà„ÄÅÂãùÊïóÂá¶ÁêÜÔºâ
  const handleGameAction = async (actionType, betResult) => {
    // „Éá„É¢„É¢„Éº„Éâ„ÅÆÂ†¥Âêà„ÅØÂ§âÊõ¥„Å™„Åó
    if (demoMode) {
      if (actionType === 'bet') {
        return true; // „Éá„É¢„É¢„Éº„Éâ„Åß„ÅØÂ∏∏„Å´„Éô„ÉÉ„ÉàÊàêÂäü
      }
      if (actionType === 'result') {
        // Âãù„Å°Ë≤†„Åë„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏„Å†„ÅëË°®Á§∫
        const { won, multiplier = 1 } = betResult;
        if (won) {
          const winAmount = betAmount * multiplier;
          toast.success(`„Äê„Éá„É¢„Äë„Åä„ÇÅ„Åß„Å®„ÅÜÔºÅ ${winAmount} PARC„ÅÆÂãùÂà©„Åß„ÅôÔºÅ`);
          
          // „Éá„É¢„É¢„Éº„Éâ„Åß„ÇÇÂèñÂºïÂ±•Ê≠¥„Å´Ë°®Á§∫
          setTransaction({
            type: 'win',
            amount: winAmount,
            game: activeGame,
            timestamp: new Date()
          });
        } else {
          toast.info('„Äê„Éá„É¢„ÄëÊÆãÂøµ„ÄÅÊ¨°Âõû„ÅÆÂãùÂà©„ÇíÁ•à„Çä„Åæ„ÅôÔºÅ');
          
          // „Éá„É¢„É¢„Éº„Éâ„Åß„ÇÇÂèñÂºïÂ±•Ê≠¥„Å´Ë°®Á§∫
          setTransaction({
            type: 'lose',
            amount: betAmount,
            game: activeGame,
            timestamp: new Date()
          });
        }
        return true;
      }
      return false;
    }
    
    if (!isAuthenticated || isProcessing) return false;
    
    try {
      setIsProcessing(true);
      
      // „Éô„ÉÉ„ÉàÂá¶ÁêÜ
      if (actionType === 'bet') {
        if (!checkBalance()) {
          toast.error('ÊÆãÈ´ò„Åå‰∏çË∂≥„Åó„Å¶„ÅÑ„Åæ„Åô');
          setIsProcessing(false);
          return false;
        }
        
        // „Éô„ÉÉ„ÉàÂâç„Å´ÊÆãÈ´ò„Çí‰∫ãÂâç„Å´Êõ¥Êñ∞„Åó„Å¶Ë°®Á§∫
        const oldBalance = balance.parc;
        const newBalance = oldBalance - betAmount;
        
        // UI‰∏ä„ÅÆÊÆãÈ´ò„Çí„Åæ„ÅöÊõ¥Êñ∞Ôºà„Ç™„Éó„ÉÜ„Ç£„Éü„Çπ„ÉÜ„Ç£„ÉÉ„ÇØUIÔºâ
        setBalance(prev => ({
          ...prev,
          parc: newBalance
        }));
        
        highlightBalanceChange(newBalance, oldBalance);
        
        // ÂèñÂºïÂ±•Ê≠¥„Å´Ë°®Á§∫
        setTransaction({
          type: 'bet',
          amount: -betAmount,
          game: activeGame,
          timestamp: new Date()
        });
        
        try {
          const response = await fetch('https://example.com/api/casino/bet', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${localStorage.getItem('token')}`,
              'Cache-Control': 'no-store, no-cache, must-revalidate',
              'Pragma': 'no-cache'
            },
            body: JSON.stringify({
              amount: betAmount,
              game: activeGame
            })
          });
          
          if (!response.ok) {
            // „Ç®„É©„Éº„ÅÆÂ†¥Âêà„ÅØÊÆãÈ´ò„ÇíÂÖÉ„Å´Êàª„Åô
            setBalance(prev => ({
              ...prev,
              parc: oldBalance
            }));
            
            const errorText = await response.text();
            let errorMessage = '„Éô„ÉÉ„Éà„Å´Â§±Êïó„Åó„Åæ„Åó„Åü';
            
            try {
              // JSON„Å®„Åó„Å¶„Éë„Éº„Çπ„Åß„Åç„ÇãÂ†¥Âêà
              const errorData = JSON.parse(errorText);
              errorMessage = errorData.detail || errorMessage;
            } catch (e) {
              // „ÉÜ„Ç≠„Çπ„Éà„ÅÆ„Åæ„Åæ‰ΩøÁî®
              if (errorText) errorMessage += `: ${errorText}`;
            }
            
            throw new Error(errorMessage);
          }
          
          // „É¨„Çπ„Éù„É≥„Çπ„Çí„ÉÜ„Ç≠„Çπ„Éà„Å®„Åó„Å¶ÂèñÂæó
          const responseText = await response.text();
          
          // „É¨„Çπ„Éù„É≥„Çπ„ÅåÁ©∫„Åß„Å™„ÅÑÂ†¥Âêà„ÅÆ„ÅøJSON„Å®„Åó„Å¶„Éë„Éº„Çπ
          let betData = {};
          if (responseText.trim()) {
            try {
              betData = JSON.parse(responseText);
            } catch (e) {
              console.warn('Failed to parse bet response:', e);
            }
          }
          
          // API„ÅåÊÆãÈ´ò„ÇíËøî„Åó„Å¶„Åç„ÅüÂ†¥Âêà„ÅØÊõ¥Êñ∞
          if (betData && betData.current_balance !== undefined) {
            setBalance(prev => ({
              ...prev,
              parc: betData.current_balance
            }));
          }

          // „Ç´„Çπ„Çø„É†„Ç§„Éô„É≥„Éà„ÇíÁô∫ÁÅ´„Åó„Å¶„Ç≤„Éº„É†„Å´ÈÄöÁü•
          window.dispatchEvent(new CustomEvent('bet-completed', { 
            detail: { success: true }
          }));
          
          return true;
        } catch (error) {
          toast.error(error.message);
          return false;
        }
      }
      
      // ÂãùÊïóÁµêÊûúÂá¶ÁêÜÈÉ®ÂàÜ„Çí‰øÆÊ≠£
      if (actionType === 'result') {
        const { won, multiplier = 1, pattern = null } = betResult;
        
        try {
          // UIÊõ¥Êñ∞„ÇíÂÖà„Å´Ë°å„ÅÜ - „Ç™„Éó„ÉÜ„Ç£„Éü„Çπ„ÉÜ„Ç£„ÉÉ„ÇØUI
          if (won) {
            const winAmount = betAmount * multiplier;
            const oldBalance = balance.parc;
            const newBalance = oldBalance + winAmount;
            
            // UI‰∏ä„ÅÆÊÆãÈ´ò„Çí„Åæ„ÅöÊõ¥Êñ∞
            setBalance(prev => ({
              ...prev,
              parc: newBalance
            }));
            
            highlightBalanceChange(newBalance, oldBalance);
            
            // ÂèñÂºïÂ±•Ê≠¥„Å´Ë°®Á§∫
            setTransaction({
              type: 'win',
              amount: winAmount,
              game: activeGame,
              timestamp: new Date()
            });
            
            toast.success(`„Åä„ÇÅ„Åß„Å®„ÅÜÔºÅ ${winAmount} PARC„ÅÆÂãùÂà©„Åß„ÅôÔºÅ`);
          } else {
            // Ë≤†„Åë„ÅÆÂ†¥Âêà
            setTransaction({
              type: 'lose',
              amount: betAmount,
              game: activeGame,
              timestamp: new Date()
            });
            
            toast.info('ÊÆãÂøµ„ÄÅÊ¨°Âõû„ÅÆÂãùÂà©„ÇíÁ•à„Çä„Åæ„ÅôÔºÅ');
          }
          
          // API„É™„ÇØ„Ç®„Çπ„Éà - „Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Å¶„ÇÇUI„ÅØÊó¢„Å´Êõ¥Êñ∞Ê∏à„Åø
          try {
            const response = await fetch('https://example.com/api/casino/result', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${localStorage.getItem('token')}`,
                'Cache-Control': 'no-store, no-cache, must-revalidate',
                'Pragma': 'no-cache'
              },
              body: JSON.stringify({
                game: activeGame,
                won,
                amount: betAmount,
                multiplier,
                pattern
              })
            });
            
            if (!response.ok) {
              console.warn(`ÁµêÊûúÂá¶ÁêÜAPI„Ç®„É©„Éº: ${response.status} ${response.statusText}`);
              // API„Ç®„É©„Éº„ÅÆÂ†¥Âêà„Åß„ÇÇËá™ÂãïÁöÑ„Å´„Éá„É¢„É¢„Éº„Éâ„Å´Âàá„ÇäÊõø„Åà„Å™„ÅÑ
              // Êó¢„Å´UI„ÅØÊõ¥Êñ∞Ê∏à„Åø„Å™„ÅÆ„Åß„É¶„Éº„Ç∂„Éº‰ΩìÈ®ì„ÅØÁ∂≠ÊåÅ„Åï„Çå„Çã
            } else {
              console.log('ÁµêÊûúÂá¶ÁêÜAPIÊàêÂäü');
            }
          } catch (apiError) {
            console.error('APIÈÄö‰ø°„Ç®„É©„Éº:', apiError);
            // API„Ç®„É©„ÉºÊôÇ„ÇÇÈùô„Åã„Å´Â§±Êïó„Åó„ÄÅ„É¶„Éº„Ç∂„Éº„Ç®„ÇØ„Çπ„Éö„É™„Ç®„É≥„Çπ„ÇíÁ∂ôÁ∂ö
          }
          
          // API„ÅÆÊàêÂê¶„Å´Èñ¢„Çè„Çâ„Åö„ÄÅÂæå„ÅßÊÆãÈ´ò„ÇíÂèñÂæó„ÅóÁõ¥„ÅôË©¶„Åø
          setTimeout(() => {
            try {
              fetchUserBalance();
            } catch (balanceError) {
              console.error('ÊÆãÈ´òÂèñÂæó„Ç®„É©„Éº:', balanceError);
              // „Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Å¶„ÇÇUIÊõ¥Êñ∞„ÅØÊó¢„Å´ÂÆå‰∫Ü„Åó„Å¶„ÅÑ„Çã„ÅÆ„Åß„É¶„Éº„Ç∂„Éº„Ç®„ÇØ„Çπ„Éö„É™„Ç®„É≥„Çπ„ÅØÁ∂≠ÊåÅ
            }
          }, 1000);
          
          return true; // Â∏∏„Å´ÊàêÂäü„ÇíËøî„Åô
        } catch (error) {
          console.error('Result processing error:', error);
          toast.error(`„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ${error.message}`);
          return false;
        }
      }
    } catch (error) {
      console.error('Casino action error:', error);
      toast.error(error.message || '„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü');
      return false;
    } finally {
      setIsProcessing(false);
    }
  };
  
  // „Ç≤„Éº„É†„Ç≥„É≥„Éù„Éº„Éç„É≥„Éà„Çí„É¨„É≥„ÉÄ„É™„É≥„Ç∞
  const renderGameComponent = () => {
    const gameProps = {
      betAmount,
      onBet: () => handleGameAction('bet'),
      onResult: (result) => handleGameAction('result', result),
      isProcessing
    };
    
    switch (activeGame) {
      case 'slot':
        return <SlotMachine {...gameProps} />;
      case 'roulette':
        return <RouletteGame {...gameProps} />;
      case 'blackjack':
        return <BlackjackGame {...gameProps} />;
      default:
        return <SlotMachine {...gameProps} />;
    }
  };

  // „Éá„É¢/Êú¨Áï™Âàá„ÇäÊõø„Åà„Éú„Çø„É≥
  const toggleMode = () => {
    if (!isAuthenticated && !demoMode) {
      navigate('/login');
      return;
    }
    
    setDemoMode(!demoMode);
  };

  // ÂèñÂºïÊÉÖÂ†±Ë°®Á§∫„ÅÆ„É¨„É≥„ÉÄ„É™„É≥„Ç∞
  const renderTransaction = () => {
    if (!transaction) return null;
    
    let icon = 'üéÆ';
    let textColor = 'text-gray-800';
    let bgColor = 'bg-gray-100';
    
    if (transaction.type === 'win') {
      icon = 'üí∞';
      textColor = 'text-green-700';
      bgColor = 'bg-green-50';
    } else if (transaction.type === 'lose') {
      icon = 'üìâ';
      textColor = 'text-red-700';
      bgColor = 'bg-red-50';
    } else if (transaction.type === 'bet') {
      icon = 'üé≤';
      textColor = 'text-amber-700';
      bgColor = 'bg-amber-50';
    }
    
    const formatTime = (date) => {
      return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
    };
    
    return (
      <motion.div 
        className={`fixed bottom-4 right-4 ${bgColor} p-4 rounded-lg shadow-lg max-w-xs ${textColor} border border-gray-200 z-50`}
        initial={{ y: 100, opacity: 0 }}
        animate={{ y: 0, opacity: 1 }}
        exit={{ y: 100, opacity: 0 }}
      >
        <div className="flex items-center">
          <span className="text-2xl mr-3">{icon}</span>
          <div>
            <div className="font-medium">
              {transaction.type === 'win' && `ÂãùÂà©: +${transaction.amount} PARC`}
              {transaction.type === 'lose' && '„Ç≤„Éº„É†Ë≤†„Åë'}
              {transaction.type === 'bet' && `„Éô„ÉÉ„Éà: ${transaction.amount} PARC`}
            </div>
            <div className="text-xs opacity-75">
              {formatTime(transaction.timestamp)} - {getGameLabel(transaction.game)}
            </div>
          </div>
        </div>
      </motion.div>
    );
  };
  
  // „Ç≤„Éº„É†Âêç„ÅÆÂèñÂæó
  const getGameLabel = (gameId) => {
    const game = gameOptions.find(g => g.id === gameId);
    return game ? game.label : '„Ç´„Ç∏„Éé„Ç≤„Éº„É†';
  };

  // ÊÆãÈ´òÂ§âÂåñ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„ÅÆ„É¨„É≥„ÉÄ„É™„É≥„Ç∞
  const renderBalanceChange = () => {
    if (!showBalanceChange || previousBalance === null || previousBalance === balance.parc) {
      return null;
    }
    
    const isIncrease = balance.parc > previousBalance;
    const difference = Math.abs(balance.parc - previousBalance);
    
    return (
      <motion.div 
        className={`absolute -top-6 ${isIncrease ? 'text-green-500' : 'text-red-500'} font-bold text-sm`}
        initial={{ opacity: 0, y: isIncrease ? 20 : -20 }}
        animate={{ opacity: 1, y: 0 }}
        exit={{ opacity: 0 }}
      >
        {isIncrease ? '+' : '-'}{difference.toLocaleString()} PARC
      </motion.div>
    );
  };

  return (
    <div className="min-h-screen bg-gradient-to-b from-amber-50 to-white py-12 px-4">
      <div className="max-w-6xl mx-auto">
        <motion.div 
          className="text-center mb-16"
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ duration: 0.6 }}
        >
          <h1 className="text-4xl font-extrabold text-gray-900 mb-4">
            <span className="inline-block animate-bounce mr-2">üé∞</span>
            Paraccoli Casino „Éó„É¨„Ç§„É´„Éº„É†
          </h1>
          <p className="text-xl text-gray-600 max-w-3xl mx-auto mb-2">
            ÈÅã„Å®Êà¶Áï•„ÇíÈßÜ‰Ωø„Åó„Å¶„ÄÅ‰∏ÄÊî´ÂçÉÈáë„ÇíÁãô„ÅÑ„Åæ„Åó„Çá„ÅÜÔºÅ
            {demoMode ? '„Äê„Éá„É¢„É¢„Éº„Éâ„Äë' : ''}
          </p>
          <div className="max-w-xl mx-auto">
            <button
              onClick={toggleMode}
              className={`text-sm px-4 py-1 rounded-full ${
                demoMode 
                  ? 'bg-green-100 text-green-700 hover:bg-green-200' 
                  : 'bg-amber-100 text-amber-700 hover:bg-amber-200'
              }`}
            >
              {demoMode 
                ? (isAuthenticated ? 'ÂÆüÈöõ„ÅÆPARC„Åß„Éó„É¨„Ç§„Åô„Çã' : '„É≠„Ç∞„Ç§„É≥„Åó„Å¶ÂÆüÈöõ„Å´„Éó„É¨„Ç§') 
                : '„Éá„É¢„É¢„Éº„Éâ„Å´Âàá„ÇäÊõø„Åà'
              }
            </button>
          </div>
        </motion.div>

        {/* ÊÆãÈ´òË°®Á§∫ - Ë™çË®ºÊ∏à„Åø„É¶„Éº„Ç∂„Éº„ÅÆ„ÅøË°®Á§∫ */}
        {isAuthenticated && (
          <motion.div 
            className="flex flex-wrap justify-center gap-6 mb-10"
            initial={{ opacity: 0 }}
            animate={{ opacity: 1 }}
            transition={{ delay: 0.3 }}
          >
            <div className={`${!demoMode ? 'bg-white' : 'bg-gray-100'} px-6 py-3 rounded-xl shadow-md flex items-center transition-all duration-300 relative`}>
              <span className="text-2xl mr-3">üí∞</span>
              <div>
                <p className="text-sm text-gray-500">PARCÊÆãÈ´ò</p>
                <AnimatePresence mode="wait">
                  <motion.p 
                    key={balance.parc}
                    className="text-xl font-bold text-amber-600"
                    initial={{ opacity: 0.5, y: 5 }}
                    animate={{ opacity: 1, y: 0 }}
                    transition={{ duration: 0.3 }}
                  >
                    {balance.parc.toLocaleString()} PARC
                  </motion.p>
                </AnimatePresence>
                <AnimatePresence>
                  {showBalanceChange && renderBalanceChange()}
                </AnimatePresence>
                <p className="text-xs text-gray-500">{demoMode ? '„Éá„É¢„É¢„Éº„Éâ‰∏≠„ÅÆ„Åü„ÇÅÂÆüÈöõ„ÅÆÊÆãÈ´ò„ÅØÂ§âÂãï„Åó„Åæ„Åõ„Çì' : ''}</p>
              </div>
            </div>
            <div className={`${!demoMode ? 'bg-white' : 'bg-gray-100'} px-6 py-3 rounded-xl shadow-md flex items-center transition-all duration-300`}>
              <span className="text-2xl mr-3">üí¥</span>
              <div>
                <p className="text-sm text-gray-500">JPYÊÆãÈ´ò</p>
                <AnimatePresence mode="wait">
                  <motion.p 
                    key={balance.jpy}
                    className="text-xl font-bold text-green-600"
                    initial={{ opacity: 0.5 }}
                    animate={{ opacity: 1 }}
                    transition={{ duration: 0.3 }}
                  >
                    {balance.jpy.toLocaleString()} JPY
                  </motion.p>
                </AnimatePresence>
              </div>
            </div>
            
            {!demoMode && (
              <button
                onClick={fetchUserBalance}
                className="bg-gray-100 hover:bg-gray-200 text-gray-700 p-2 rounded-full"
                title="ÊÆãÈ´ò„ÇíÊõ¥Êñ∞"
              >
                <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                  <path fillRule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clipRule="evenodd" />
                </svg>
              </button>
            )}
          </motion.div>
        )}

        {/* „Éá„É¢„É¢„Éº„ÉâË°®Á§∫ */}
        {demoMode && (
          <motion.div 
            className="bg-amber-50 border border-amber-200 rounded-lg p-4 mb-8 max-w-3xl mx-auto"
            initial={{ opacity: 0 }}
            animate={{ opacity: 1 }}
          >
            <div className="flex items-start">
              <div className="flex-shrink-0 mt-1">
                <svg className="h-5 w-5 text-amber-600" viewBox="0 0 20 20" fill="currentColor">
                  <path fillRule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clipRule="evenodd" />
                </svg>
              </div>
              <div className="ml-3 text-left">
                <h3 className="text-sm font-medium text-amber-800">„Éá„É¢„É¢„Éº„Éâ</h3>
                <div className="mt-1 text-sm text-amber-700">
                  <p>
                    „Éá„É¢„É¢„Éº„Éâ„Åß„ÅØÂÆüÈöõ„ÅÆÊÆãÈ´ò„ÅØÊ∂àË≤ª„Åï„Çå„Åæ„Åõ„Çì„ÄÇÂÆüÈöõ„Å´ÈÅä„Å∂„Å´„ÅØ
                    <button 
                      onClick={() => isAuthenticated ? setDemoMode(false) : navigate('/login')}
                      className="underline text-amber-600 hover:text-amber-800"
                    >
                      {isAuthenticated ? 'ÂÆüÈöõ„ÅÆPARC„Åß„Éó„É¨„Ç§' : '„É≠„Ç∞„Ç§„É≥'}
                    </button>
                    „Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
                  </p>
                </div>
              </div>
            </div>
          </motion.div>
        )}

        {/* „Ç≤„Éº„É†ÈÅ∏Êäû„Çø„Éñ */}
        <motion.div
          className="bg-white rounded-xl shadow-md p-1 flex justify-center mb-8"
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ duration: 0.5, delay: 0.2 }}
        >
          {gameOptions.map((game) => (
            <button
              key={game.id}
              className={`px-6 py-3 rounded-lg flex items-center whitespace-nowrap ${
                activeGame === game.id 
                  ? 'bg-amber-500 text-white' 
                  : 'text-gray-700 hover:bg-gray-100'
              }`}
              onClick={() => setActiveGame(game.id)}
            >
              <span className="text-xl mr-2">{game.icon}</span>
              {game.label}
            </button>
          ))}
        </motion.div>

        {/* „Éô„ÉÉ„ÉàÈ°çÈÅ∏Êäû */}
        <motion.div 
          className="mb-8 text-center"
          initial={{ opacity: 0 }}
          animate={{ opacity: 1 }}
          transition={{ delay: 0.3 }}
        >
          <p className="text-gray-700 mb-3">„Éô„ÉÉ„ÉàÈ°ç„ÇíÈÅ∏Êäû</p>
          <div className="flex flex-wrap justify-center gap-3">
            {betOptions.map((amount) => (
              <button
                key={amount}
                onClick={() => setBetAmount(amount)}
                disabled={!demoMode && amount > balance.parc}
                className={`${
                  betAmount === amount 
                    ? 'bg-amber-500 text-white' 
                    : (!demoMode && amount > balance.parc)
                      ? 'bg-gray-200 text-gray-400 cursor-not-allowed'
                      : 'bg-amber-50 text-amber-800 hover:bg-amber-100'
                } px-3 py-1 rounded`}
              >
                {amount}
              </button>
            ))}
          </div>
        </motion.div>

        {/* „Ç≤„Éº„É†Ë°®Á§∫„Ç®„É™„Ç¢ */}
        <motion.div
          className="bg-white rounded-xl shadow-lg p-6 md:p-10"
          initial={{ opacity: 0 }}
          animate={{ opacity: 1 }}
          transition={{ delay: 0.4 }}
        >
          {renderGameComponent()}
        </motion.div>
        
        {/* ÂèñÂºïÂ±•Ê≠¥Ë°®Á§∫ */}
        <AnimatePresence>
          {transaction && renderTransaction()}
        </AnimatePresence>
        
        {/* „Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥„É™„É≥„ÇØ */}
        <motion.div 
          className="mt-10 flex justify-center gap-6"
          initial={{ opacity: 0 }}
          animate={{ opacity: 1 }}
          transition={{ delay: 0.5 }}
        >
          <Link to="/casino" className="text-gray-600 hover:text-amber-600 inline-flex items-center">
            <svg className="w-4 h-4 mr-1" viewBox="0 0 20 20" fill="currentColor">
              <path fillRule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clipRule="evenodd" />
            </svg>
            „Ç´„Ç∏„Éé„Éà„ÉÉ„Éó„Å´Êàª„Çã
          </Link>
          <Link to="/casino/leaderboard" className="text-amber-600 hover:text-amber-700 inline-flex items-center">
            „É©„É≥„Ç≠„É≥„Ç∞„ÇíË¶ã„Çã
            <svg className="w-4 h-4 ml-1" viewBox="0 0 20 20" fill="currentColor">
              <path fillRule="evenodd" d="M10.293 5.293a1 1 0 011.414 0l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414-1.414L12.586 11H5a1 1 0 110-2h7.586l-2.293-2.293a1 1 0 010-1.414z" clipRule="evenodd" />
            </svg>
          </Link>
        </motion.div>
      </div>
    </div>
  );
};

export default CasinoPlay;